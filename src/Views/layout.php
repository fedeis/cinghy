<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?php echo $title ?? 'Cinghy'; ?></title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Base Styles -->
    <link rel="stylesheet" href="/css/app.css">
    <link rel="stylesheet" href="/css/widgets.css">
    <?php if (isset($extra_css)): foreach ($extra_css as $css): ?>
        <link rel="stylesheet" href="/css/<?php echo $css; ?>.css">
    <?php endforeach; endif; ?>
    
    <?php
    $settings = \App\Core\UserContext::get()->getSettings();
    $accentColor = $settings['accent_color'] ?? '#0774e9';
    $theme = $settings['theme'] ?? 'system';

    function getContrastColor($hex) {
        $hex = str_replace('#', '', $hex);
        if (strlen($hex) == 3) {
            $hex = $hex[0] . $hex[0] . $hex[1] . $hex[1] . $hex[2] . $hex[2];
        }
        $r = hexdec(substr($hex, 0, 2));
        $g = hexdec(substr($hex, 2, 2));
        $b = hexdec(substr($hex, 4, 2));
        $yiq = (($r * 299) + ($g * 587) + ($b * 114)) / 1000;
        return ($yiq >= 128) ? '#000000' : '#ffffff';
    }
    function getDarkerColor(string $hex, int $amount = 40): string
    {
        $hex = ltrim($hex, '#');

        $r = max(0, hexdec(substr($hex, 0, 2)) - $amount);
        $g = max(0, hexdec(substr($hex, 2, 2)) - $amount);
        $b = max(0, hexdec(substr($hex, 4, 2)) - $amount);

        return sprintf('#%02x%02x%02x', $r, $g, $b);
    }
    $accentContrast = getContrastColor($accentColor);
    $accentColorDarker = getDarkerColor($accentColor);
    ?>
    <style>
        :root {
            --accent-color: <?php echo $accentColor; ?>;
            --accent-color-darker: <?php echo $accentColorDarker; ?>;
            --accent-contrast: <?php echo $accentContrast; ?>;
        }
    </style>
    <script>
        (function() {
            const theme = <?php echo json_encode($theme); ?>;
            const applyTheme = (t) => {
                let actual = t;
                if (t === 'system') {
                    actual = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                }
                document.documentElement.setAttribute('data-theme', actual);
            };
            applyTheme(theme);
            if (theme === 'system') {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => applyTheme('system'));
            }
        })();
    </script>
</head>
<body>
    <?php
    $currentPath = parse_url($_SERVER['REQUEST_URI'], PHP_URL_PATH);
    ?>
    <nav id="menu-island">
        <a href="/" class="<?php echo $currentPath === '/' ? 'active' : ''; ?>">
            <svg viewBox="0 0 1024 1024" fill="currentColor"><path d="M709.997,807.823C726.452,807.776 742.907,807.82 759.362,807.786C762.542,807.779 765.677,807.911 768.771,808.71C776.005,810.58 779.714,815.757 779.333,823.512C779.011,830.041 774.226,835.278 767.413,836.288C764.461,836.725 761.451,836.956 758.467,836.957C612.145,836.979 465.822,836.966 319,836.958C258.67,836.961 198.841,836.974 139.011,836.942C135.857,836.94 132.658,836.831 129.557,836.308C123.021,835.206 118.243,829.763 117.721,823.259C117.243,817.305 121.414,811.147 127.49,809.044C130.172,808.116 132.962,807.765 135.838,807.777C151.336,807.838 166.836,807.818 182.335,807.788C184.281,807.785 186.309,808.1 188.767,806.77C185.981,798.266 183.135,789.827 180.453,781.337C174.345,762.009 168.164,742.716 163.432,722.966C160.307,709.927 162.474,698.009 168.23,686.297C180.294,661.745 180.471,661.53 168.166,637.152C157.262,615.548 147.371,593.604 142.274,569.817C140.333,560.755 138.914,551.581 137.14,541.81C131.117,544.786 125.296,547.845 118.731,548.922C82.232,554.912 51.857,525.823 54.78,491.822C56.629,470.313 75.245,450.543 96.374,446.82C108.769,444.636 117.603,452.303 115.372,463.374C114.279,468.797 110.935,472.083 105.528,473.389C97.897,475.233 91.143,478.55 86.587,485.306C79.74,495.461 82.314,508.368 92.256,515.7C109.494,528.412 128.629,517.467 134.743,502.858C136.647,498.307 135.995,493.321 136.439,488.582C140.58,444.39 156.493,404.874 184.447,370.638C217.429,330.243 258.649,302.264 310.445,291.458C311.886,291.157 313.29,290.674 314.803,290.25C314.572,287.91 312.608,286.888 311.523,285.315C305.251,276.219 309.109,265.2 319.837,262.654C337.945,258.357 356.281,257.747 374.814,259.38C387.822,260.527 400.37,263.483 412.844,267.041C413.454,267.215 414.092,267.612 414.899,266.802C413.505,261.911 410.184,257.861 407.966,253.27C403.05,243.094 408.554,231.643 421.503,232.018C428.572,232.222 435.632,233.878 442.629,235.225C465.801,239.683 487.924,247.213 508.793,258.309C509.5,258.685 510.292,258.9 511.505,259.368C513.683,253.725 512.923,247.943 513.418,242.495C515.194,222.936 518.664,203.708 522.981,184.596C523.675,181.521 524.358,178.439 525.203,175.403C528.618,163.135 538.142,159.368 548.956,166.078C561.129,173.63 573.122,181.459 584.694,189.916C609.833,208.289 632.864,228.854 651.306,254.165C659.758,265.764 667.35,277.883 673.263,291.002C674.282,293.262 675.406,295.473 676.911,298.598C677.596,294.84 678.053,292.008 678.634,289.202C681.031,277.634 690.702,273.295 700.956,279.465C710.042,284.933 717.318,292.545 724.221,300.486C739.646,318.23 749.059,339.392 758.326,360.637C765.392,376.837 772.611,392.923 784.432,406.455C797.523,421.442 814.44,430.401 832.382,438.012C852.815,446.68 873.696,453.771 895.65,457.385C905.38,458.987 915.213,458.979 925.022,458.608C939.718,458.051 949.292,465.474 955.374,478.032C961.044,489.74 962.092,502.432 961.058,515.115C959.705,531.717 956.332,547.992 950.026,563.523C946.686,571.747 942.721,579.63 936.19,585.868C930.429,591.369 923.629,594.416 915.517,594.378C900.351,594.307 885.185,594.398 870.02,594.299C866.673,594.277 864.061,595.28 861.414,597.418C815.725,634.33 765.395,662.6 708.729,678.984C706.335,679.676 703.954,680.723 701.517,680.893C699.87,681.008 698.601,681.396 697.621,682.001C687.613,683.944 672.854,686.844 664.946,688.568C658.979,687.495 656.44,688.405 655.608,691.918C650.325,714.216 645.684,736.639 642.302,759.321C640.148,773.769 639.17,788.332 637.472,802.821C637.034,806.553 638.219,808.109 642.015,807.868C644.836,807.69 647.679,807.844 651.503,807.851C653.006,807.843 654.508,807.833 656.01,807.824L656,808L710,808L709.997,807.823ZM343.914,710.16C337.64,708.36 331.57,706.667 325.553,704.805C323.171,704.067 321.791,705.196 320.318,706.651C310.136,716.708 300.318,727.148 289.334,736.365C287.761,737.685 287.256,739.028 287.663,741.127C291.676,761.782 295.611,782.452 299.483,803.134C300.152,806.705 301.915,807.978 305.608,807.909C314.043,807.751 322.482,807.817 330.92,807.823L331,808L406,808C406,808 406.002,807.949 406.004,807.849C446.084,807.801 486.164,807.8 526.244,807.849C530.282,807.854 530.866,806.506 530.007,802.688C526.945,789.094 524.324,775.401 521.489,761.755C518.858,749.089 516.184,736.431 513.491,723.778C512.818,720.617 512.37,717.62 507.485,719.05C503.728,720.15 499.596,720.104 495.618,720.29C476.2,721.199 456.798,723.152 436.369,721.353C417.211,721.339 398.208,719.207 379.228,716.943C378.429,716.847 377.732,716.818 377.114,716.887C358.436,714.199 344,710 344,710L343.914,710.16ZM226.29,366.794C219.317,373.262 212.899,380.275 206.994,387.696C173.26,430.088 159.655,478.481 164.26,532.24C166.378,556.966 173.124,580.508 182.116,603.522C186.92,615.816 193.511,627.223 199.179,639.087C206.609,654.641 207.188,670.062 199.29,685.605C197.33,689.463 195.686,693.481 193.752,697.354C190.02,704.825 189.278,712.619 191.225,720.651C198.168,749.296 207.969,777.037 217.9,804.737C218.698,806.963 220.044,807.846 222.362,807.837C237.528,807.784 252.694,807.766 267.861,807.817C271.018,807.827 272.009,806.5 271.426,803.485C267.299,782.149 263.411,760.764 259.027,739.482C257.314,731.168 259.295,725.044 266.165,719.914C280.007,709.577 291.478,696.859 301.93,683.154C308.41,674.659 313.715,665.397 319.806,656.658C323.294,651.653 327.979,648.025 334.505,649.245C342.481,650.735 346.945,658.768 344.855,666.868C343.732,671.221 341.37,675.061 339.699,679.035C340.961,680.764 342.738,681.003 344.283,681.38C355.09,684.016 366.007,686.123 377.027,687.642C392.844,689.823 408.721,691.187 424.686,691.929C455.338,693.354 485.911,693.248 516.329,688.774C529.941,686.772 534.692,689.755 537.897,703.249C538.089,704.056 538.225,704.877 538.396,705.689C545.29,738.327 545.29,738.327 545.29,738.327L545.29,738.327C545.29,738.327 552.232,770.955 559.002,803.62C559.621,806.605 560.568,807.913 563.764,807.881C577.596,807.747 591.431,807.728 605.263,807.862C608.921,807.898 609.564,806.26 609.744,803.021C610.224,794.406 610.804,785.771 611.94,777.223C613.952,762.099 616.095,746.979 618.75,731.958C622.392,711.348 626.698,690.862 633.615,671.039C636.232,663.538 640.113,661.112 648.167,660.583C662.074,659.67 675.939,658.384 689.528,654.932C725.96,645.676 759.955,630.656 792.206,611.561C802.175,605.658 811.81,599.192 822.332,592.518C820.367,591.973 819.43,591.504 818.483,591.483C806.315,591.22 794.357,589.162 782.371,587.343C757.676,583.593 734.915,574.664 713.64,561.718C707.991,558.281 705.599,553.32 706.787,546.934C707.885,541.027 712.158,538.1 717.68,536.526C723.6,534.839 729.404,532.795 735.032,530.266C756.871,520.448 773.906,504.851 788.259,486.036C791.32,482.023 795.085,479.178 800.222,478.694C809.346,477.834 815.216,482.818 817.228,493.776C819.565,506.504 818.557,519.298 816.814,532.018C815.391,542.401 812.189,552.303 807.67,562.181C817.884,562.758 827.654,563.236 837.413,563.88C851.529,564.812 865.644,565.839 879.799,565.589C886.484,565.471 887.311,564.225 886.303,557.752C885.998,555.791 885.844,553.783 885.866,551.8C886.093,531.819 889.645,512.492 897.208,493.935C898.102,491.742 899.502,489.524 898.934,486.765C894.504,486.078 890.244,485.503 886.016,484.746C859.092,479.922 833.892,469.98 809.358,458.306C789.773,448.986 772.04,436.966 758.609,419.525C748.061,405.826 740.613,390.367 733.784,374.592C725.641,355.784 717.519,336.965 704.819,320.609C703.672,319.132 702.924,317.01 700.163,317.041C699.494,318.486 698.82,319.985 698.109,321.466C694.485,329.01 690.455,336.289 684.082,341.935C678.788,346.626 672.87,348.243 666.133,345.224C660.6,342.745 658.974,337.666 657.703,332.412C651.648,307.385 640.003,285.191 624.112,265.035C605.622,241.582 582.704,223.218 558.059,206.793C555.24,204.914 552.673,202.407 548.914,201.78C548.647,202.718 548.433,203.327 548.301,203.954C543.142,228.559 539.662,253.333 540.291,278.574C540.972,305.864 546.691,331.026 568.415,350.094C573.534,354.587 573.76,362.551 569.919,367.836C566.198,372.955 558.945,374.859 552.898,372.132C548.746,370.258 545.322,367.287 542.162,364.079C524.649,346.296 517.196,323.992 513.808,299.985C513.363,296.831 512.247,294.769 509.789,293.034C502.297,287.744 494.631,282.76 486.394,278.676C473.257,272.163 459.612,267.234 445.125,264.691C444.964,265.386 444.749,265.748 444.843,265.99C447.472,272.821 450.072,279.664 452.807,286.453C454.628,290.975 455.233,295.435 452.851,299.922C448.961,307.247 440.66,308.966 431.039,304.249C408.788,293.338 385.348,287.191 360.548,286.4C358.126,286.323 355.638,286.218 353.375,287.817C353.838,288.372 354.111,288.778 354.459,289.104C359.444,293.774 361.228,299.395 358.688,305.813C356.154,312.218 350.735,314.058 344.241,314.474C337.966,314.876 331.699,315.823 325.504,316.945C287.806,323.775 255.163,340.774 226.29,366.794ZM932.775,494.05C932.174,492.728 932.046,491.136 930.677,490.233C919.055,501.078 909.064,553.721 916.357,565.811C919.154,564.545 920.295,561.858 921.684,559.455C925.296,553.207 927.564,546.395 929.129,539.417C932.425,524.728 936.339,510.05 932.775,494.05ZM772.218,540.764L756.177,552.235C763.032,555.355 769.513,556.697 775.935,558.24C777.53,558.623 778.495,557.815 779.22,556.61C785.056,546.917 789.101,536.616 790.334,524.194C783.84,529.92 778.977,535.871 772.218,540.764Z"/>
            <span><?php echo __('nav_home'); ?></span>
        </a>
        <a href="/transactions" class="<?php echo $currentPath === '/transactions' ? 'active' : ''; ?>">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
            <span><?php echo __('nav_transactions'); ?></span>
        </a>
        <!-- <a href="/recurring" class="<?php echo (str_starts_with($currentPath, '/recurring')) ? 'active' : ''; ?>">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
            <span><?php echo __('nav_automated'); ?></span>
        </a> -->
        <a href="/files" class="<?php echo (str_starts_with($currentPath, '/files')) ? 'active' : ''; ?>">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
            <span><?php echo __('nav_files'); ?></span>
        </a>
        <a href="/settings" class="<?php echo $currentPath === '/settings' ? 'active' : ''; ?>">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            <span><?php echo __('nav_settings'); ?></span>
        </a>
    </nav>

    <main class="container">
        <?php echo $content; ?>
    </main>

    <footer>
        <strong>Cinghy</strong> is made with love by <a href="https://fede.is">Fede</a>
    </footer>

    <!-- Base Scripts -->
    <?php if (isset($extra_js)): foreach ($extra_js as $js): ?>
        <script src="/js/<?php echo $js; ?>.js"></script>
    <?php endforeach; endif; ?>
</body>
</html>
